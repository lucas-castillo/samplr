---
title: "ABS Parameter Recovery"
autor: Yun-Xiao Li
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ABS Parameter Recovery}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette provides the `R` scripts for parameter recovery of the Autocorrelated Bayesian sampler (ABS, Zhu et al., 2023). As ABS does not have analytical likelihood function, we employed the Approximate Bayesian Computation to conduct the parameter estimation, and the package [`abc`](https://cran.r-project.org/web/packages/abc/index.html) is required.


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# ABS simulation

As a first step, we randomly generate a set of parameters and run a simulation of ABS.

```{r, message=FALSE, warning=FALSE}
require(samplr) # for the ABS
require(tidyverse)
require(abc) # for the ABC estimation
require(fdrtool) # for rhalfnorm distribution
require(ggplot2) # for ploting figures
require(gridExtra)
set.seed(2023)

params <- c(
  dec_bdry = 0, # the decision boundary that separates the posterior distribution into two parts
  discrim = 2, # the separation of the two distribution under the framework of Signal Detection Theory
  delta = 4, # the threshold for the difference of the numbers of samples supporting each response
  lambda = 14, # the rate of the sampling process
  nd_time = 0.3, # the lower bound of non-decision time
  s_nd_time = 0.1, # the range of non-decision time
  nChains = 10, # the number of MC3 chains
  width = 1 # the width of the proposal distribution
)

feedback <- sample(c(0,1), 200, replace = T) # the feedbacks, or say the stimuli, of each trial

ABS.sim <- rABS(params['dec_bdry'], params['discrim'], params['delta'], params['nd_time'], params['s_nd_time'],
                params['lambda'], feedback, params['nChains'], params['width'])
```

We can have an overview of the response time (RT) distributions.

```{r, fig.height=4, fig.width=7}
ggplot(data=ABS.sim, aes(x=rt))+
  geom_histogram(fill = "skyblue", color = "black", bins = 30) +
  labs(title = "Distribution of Response Time (RT)", x = "RT", y = "Frequency") +
  theme_minimal()
```

# ABC Estimation

We now consider the simulated results and empirical data and run the ABC estimation to check if we can recover the parameters. The ABC method requires summary statistics, which will be the RT quantiles, the accuracy of each stimulus, and the probability of repeats after correct and error responses in our analysis.

```{r}
summaryStats <- function(data, probs){
  
  #filter the data based on the response times
  data_clean <- filter(data, rt > 0.1 & rt < 1.5)
  
  #calculate the quantiles
  #seperate the data results based on the accuracy
  data_err <- filter(data_clean, accuracy==0)
  data_cor <- filter(data_clean, accuracy==1)
  
  #calculate the quantiles for each response
  qt_err <- quantile(data_err$rt, probs)
  qt_cor <- quantile(data_cor$rt, probs)
  
  #calculate the accuracies for each feedback
  acc_0 <- mean(data_clean$accuracy[which(data_clean$feedback == 0)])
  acc_1 <- mean(data_clean$accuracy[which(data_clean$feedback == 1)])
  
  #calculate the probability of repeats after correct and error
  prob_rept_err <- mean(data_err$rept, na.rm=T)
  prob_rept_cor <- mean(data_cor$rept, na.rm=T)
  
  return(c(qt_err, qt_cor, acc_0, acc_1, prob_rept_err, prob_rept_cor))
}

empStats <- summaryStats(ABS.sim, c(0.1, 0.3, 0.5, 0.7, 0.9))
```




```{r}
bar_acc <- ggplot(data=ABS.sim, aes(x=factor(feedback), fill=factor(accuracy))) +
  geom_bar(position = 'dodge', stat = 'prop') +
  labs(title = "Accuracy by Feedback", x = "Feedback", y = "Count") +
  scale_fill_manual(values = c("0" = "red", "1" = "green")) +
  theme_minimal()
bar_acc
```
 
```{r}
plot_rept <- ggplot(ABS.sim, aes(x = factor(accuracy), fill = factor(rept))) +
  geom_bar(position = "dodge") +
  labs(title = "Rept by Feedback", x = "Accuracy", y = "Count") +
  scale_fill_manual(values = c("TRUE" = "blue", "FALSE" = "orange", "NA" = "gray")) +
  theme_minimal()
plot_rept
```
 


# References

- Zhu, J.-Q., Sundh, J., Spicer, J., Chater, N., & Sanborn, A. N. (2023). The Autocorrelated Bayesian Sampler: A rational process for probability judgments, estimates, confidence intervals, choices, confidence judgments, and response times. Psychological Review. https://doi.org/10.1037/rev0000427
